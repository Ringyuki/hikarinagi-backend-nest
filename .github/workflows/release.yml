name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.10.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Run tests
        run: pnpm run test

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges $PREVIOUS_TAG..HEAD)
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > changelog.txt

          # è®¾ç½®è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ğŸš€ å‘å¸ƒè¯´æ˜

            ### ğŸ“‹ å˜æ›´å†…å®¹
            ${{ steps.changelog.outputs.changelog }}

                        ### ğŸ”§ éƒ¨ç½²å‘½ä»¤
            ```bash
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main

            # å®‰è£…ä¾èµ–
            pnpm install --frozen-lockfile

            # æ„å»ºåº”ç”¨
            pnpm run build

            # ä½¿ç”¨ PM2 é‡å¯åº”ç”¨
            pm2 restart ecosystem.config.js --env production
            pm2 save
            ```
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

      - name: Upload build artifacts
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist
          asset_name: hikarinagi-backend-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
      - name: Notify team
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬ ${{ github.ref_name }} å·²æˆåŠŸå‘å¸ƒï¼"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€åˆ° Slackã€Discord ç­‰
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸ‰ hikarinagi-backend ç‰ˆæœ¬ ${{ github.ref_name }} å·²æˆåŠŸå‘å¸ƒï¼"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
